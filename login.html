<!DOCTYPE html>
<html lang="zh_CN">

<head>
    <meta charset="UTF-8">
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <!-- normal script imports etc  -->
    <script src="./scripts/jquery-3.3.1.js"></script>
    <!-- Insert this line after script imports -->
    <script>
        if (window.module)
            module = window.module;

    </script>

    <link rel="stylesheet" type="text/css" href="scripts/jquery-easyui/themes/ui-cupertino/easyui.css">
    <link rel="stylesheet" type="text/css" href="scripts/jquery-easyui/themes/icon.css">
    <script type="text/javascript" src="scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="scripts/db.js"></script>

    <style type="text/css">
        * {
            font-size: 12px;
            padding: 0;
            margin: 0;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: verdana, helvetica, arial, sans-serif;
            padding: 0px;
            font-size: 12px;
            margin: 0px;
            overflow: hidden;
        }

        h2 {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            margin-bottom: 15px;
        }

        .demo-info {
            padding: 0 0 12px 0;
        }

        .demo-tip {
            display: none;
        }

        #title_bar {
            -webkit-app-region: drag;
            border: 0px solid red;
            background-color: #ffffff;
            width: 100%;
            height: 24px;
            line-height: 24px;
            font-size: 12px;
        }

        .win_btn_tb {
            width: 90px;
            height: 24px;
            text-align: left;
            position: absolute;
            border-collapse: collapse;
            top: 0px;
            right: 2px;
        }

        a.win_btn {
            width: 45px;
            height: 24px;
            text-align: center;
            display: block;
            -webkit-app-region: no-drag;
            cursor: default;

        }

        win_btn_tb td {
            padding: 0 4px;
        }

        .win_btn_tb a:hover {
            background-color: #eee;

        }

        .win_btn_tb a:hover#close_btn {
            background-color: red
        }

        .win_btn_tb a svg {
            fill: #666666;
        }

        .win_btn_tb a:hover svg {
            fill: black;
        }

        .win_btn_tb a:hover#close_btn svg {
            fill: white;
        }

        .combo-arrow {
            background-color: #fff;
        }

        .combo-arrow-hover {
            background-color: #fff;
        }

        .combo-arrow:hover {
            background-color: #fff;
        }
    </style>
</head>

<body>
    <div id="title_bar">
        <div style="height:20px; width:20px; margin:3px 2px 0px 5px; line-height: 20px; float:left; background-color:#fff;">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                width="18px" height="18px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000"
                xml:space="preserve">
                <g>
                    <path fill="#1f637b" d="M418,496.3c0-17.3-15.2-31.3-34-31.3H232.3c-18.8,0-34,14.1-34,31.3c0,17.3,15.2,31.3,34,31.3H384C402.8,527.6,418,513.5,418,496.3z M135.3,857.2c-25.8,0-46.8-21.3-46.8-47.5V182.7c0-26.2,20.9-47.4,46.8-47.4h502.8c25.8,0,46.8,21.3,46.8,47.4v219.4c27.3,0,53.2,4.6,78.5,11.1V103.8c0-25.9-21.2-47-47.5-47H57.5c-26.2,0-47.5,21.1-47.5,47v784.9c0,25.9,21.3,47,47.5,47h403.6c-22.4-22.8-40.4-49.7-55.1-78.5L135.3,857.2L135.3,857.2z M632.6,626l-47.9,47.8l86.9,86.6l-1,1l47.8,47.8l1-1l1,1l47.9-47.8l-1-1L990,538.3l-47.9-47.8L719.5,712.6L632.6,626z M353,621.8H231.9c-18.6,0-33.6,14.1-33.6,31.3c0,17.4,15,31.4,33.6,31.4H353c18.6,0,33.6-14.1,33.6-31.4C386.6,635.8,371.6,621.8,353,621.8z M865,731.8c-12.4,80.1-81.2,141.5-164.9,141.5c-92.6,0-167.6-74.9-167.6-167.2c0-92.3,75-167.2,167.6-167.2c35.3,0,67.9,11,94.9,29.6l49.5-49.4c-40.1-30.9-89.8-50.1-144.5-50.1C568.8,468.9,462.4,575,462.4,706c0,130.9,106.4,237.1,237.7,237.1c131.3,0,237.7-106.2,237.7-237.1c0-14.6-1.8-28.7-4.3-42.6L865,731.8z M590.6,323.7c0-17.3-15-31.4-33.8-31.4H232.2c-18.7,0-33.8,14.1-33.8,31.4s15.1,31.3,33.8,31.3h324.7C575.6,355,590.6,340.9,590.6,323.7z" />
                </g>
            </svg>
        </div>
        <div style="height:24px; line-height:24px; margin:0 0 0 2px; padding:0;  display: inline-block;">系统登录
        </div>

        <table class="win_btn_tb">
            <tr>
                <td>
                    <a class="win_btn" id="setting_btn" onclick="showSetting()">
                        <svg version="1.1" id="login_form_svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                            x="0px" y="0px" width="10px" height="10px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000"
                            xml:space="preserve">
                            <g>
                                <g transform="translate(0.000000,511.000000) scale(0.100000,-0.100000)">
                                    <path d="M4195.9,4959.7c-47.7-47.7-50.3-82.9-50.3-708.6v-660.9l-243.7-75.4c-133.2-40.2-361.8-133.2-507.6-206.1l-266.4-133.2l-464.9,464.9c-354.3,354.3-480,464.9-527.7,464.9c-90.5,0-1130.8-1040.3-1130.8-1130.8c0-47.7,110.6-173.4,464.9-527.7l464.9-464.9l-133.2-266.4c-72.9-145.7-165.8-374.4-206.1-507.6l-75.4-243.8H858.9c-625.7,0-660.9-2.5-708.6-50.3C102.5,866.4,100,831.2,100,110c0-721.2,2.5-756.3,50.3-804.1c47.7-47.8,82.9-50.3,708.6-50.3h660.9l75.4-243.8c40.2-133.2,133.2-361.8,206.1-507.6l133.2-266.3l-464.9-464.9c-354.3-354.3-464.9-479.9-464.9-527.7c0-90.5,1040.3-1130.8,1130.8-1130.8c47.7,0,173.4,110.6,527.7,464.9l467.4,467.4l241.2-125.6c135.7-67.8,361.8-160.8,507.6-206l266.4-85.4v-658.4c0-628.2,2.5-663.4,50.3-711.1c47.7-47.8,82.9-50.3,804.1-50.3c721.2,0,756.3,2.5,804.1,50.3s50.3,82.9,50.3,711.1v658.4l263.8,85.4c145.7,45.2,374.4,138.2,507.6,208.6l243.8,123.1l464.9-464.9c356.8-356.8,482.4-467.4,530.2-467.4c90.5,0,1130.8,1040.3,1130.8,1130.8c0,47.8-113.1,173.4-467.4,530.2l-464.9,464.9l123.1,243.8c70.4,133.2,163.3,361.9,208.6,507.6l85.4,263.8h660.9c625.7,0,660.9,2.5,708.6,50.3S9900-611.2,9900,110c0,721.2-2.5,756.4-50.3,804.1c-47.8,47.7-82.9,50.3-708.6,50.3h-660.9l-85.4,266.4c-45.2,145.7-138.2,371.9-206,507.6l-125.6,241.2l467.4,467.4c354.3,354.3,464.9,480,464.9,527.7c0,90.5-1040.3,1130.8-1130.8,1130.8c-47.8,0-173.4-110.6-527.7-464.9l-464.9-464.9l-266.3,133.2c-145.8,72.9-374.4,165.8-507.6,206.1l-243.8,75.4v660.9c0,625.7-2.5,660.9-50.3,708.6c-47.8,47.7-82.9,50.3-804.1,50.3C4278.8,5010,4243.6,5007.5,4195.9,4959.7z M5429.7,2635.4C6661,2421.8,7563.1,1351.3,7563.1,110c0-1407.2-1155.9-2563.1-2563.1-2563.1S2436.9-1297.2,2436.9,110c0,970,550.3,1857,1419.7,2291.7C4341.6,2642.9,4904.5,2728.4,5429.7,2635.4z" />
                                </g>
                            </g>
                        </svg>
                        <svg version="1.1" id="login_setting_svg" style="display: none;" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="10px" height="10px"
                            viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
                            <g>
                                <path d="M989.8,989.2H10.2c0-121.5-3.5-170.7,18.3-218c21.9-47.5,65-77.2,135.6-93.4c177.7-41,177.3-54.9,156.4-93.3c-98.2-180.8-116-341.2-50.2-451.8C316.4,55.3,400.2,10.8,500,10.8c99.2,0,182.4,43.9,228.3,120.2C808.9,265,753,446,679.8,584.1c-20.6,38.7-21,52.8,156.2,93.7c70.6,16.3,113.6,45.9,135.5,93.4C993.2,818.3,989.8,866.2,989.8,989.2z M105.4,893.8h789.1c0.1-85.8-5.7-105.9-80.2-123c-101.5-23.4-198.1-44.7-229.7-113.9c-15.8-34.7-12.1-74.2,10.8-117.5c55-103.8,111.3-259,51.1-359.2c-28.7-47.7-80.8-74-146.6-74c-66.3,0-118.8,26.8-147.7,75.3c-47.2,79.3-28.2,209.5,52.1,357.4c23.4,43.1,27.3,82.6,11.6,117.4c-31.7,70.2-128.7,91-230.4,114.4C111.1,787.9,105.4,808,105.4,893.8z" />
                            </g>
                        </svg>
                    </a>

                <td>
                    <a class="win_btn" href="#" id="close_btn" onclick="closewin()">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                            x="0px" y="0px" width="10px" height="10px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000"
                            xml:space="preserve">
                            <g>
                                <path d="M990,54.1l-43.3-43.4L500,456.7L53.3,10.7L10,54.1l446.6,446L10,946l43.3,43.3l446.7-446l446.7,446L990,946L543.4,500L990,54.1z" />
                            </g>
                        </svg>
                    </a>
                </td>
            </tr>
        </table>
    </div>




    <div id="login_form_panel" class="easyui-panel" data-options="border:false, fit:true" style="width:100%; padding:0px 0px; margin-top:0px; text-align: center">
        <div style="height:110px; background-image:url('images/login_bg.jpg'); line-height:110px; font-size:38px; color:#fff; -webkit-user-select: none;  -webkit-app-region: drag;">
            KIS销售管理系统
        </div>
        <table style="width:300px; margin:10px auto 0px ; border:0px solid red; ">
            <tr>
                <td rowspan="2" style="width:64px; padding:5px 10px 0px 0px; border:0px solid red; -webkit-user-select: none;">
                    <div style="width:64px; height:64px;-webkit-user-select: none; background-image:url('images/login.png')"></div>
                </td>

                <td style="padding:5px 0px 2px 0px; -webkit-app-region: no-drag;">
                    <input class="easyui-combobox" id="username" style="width:100%;height:30px;padding:2px 10px; font-size:22px;"
                        data-options="validateOnCreate:false, required:true, prompt:'输入账号',iconWidth:38, panelHeight:85, valueField: 'name', onChange:changeUser,
                    textField: 'name'">
                </td>
            </tr>
            <tr>
                <td style=" padding:2px 0px 5px 0px; -webkit-app-region: no-drag;">
                    <input id="password" class="easyui-passwordbox" style="width:100%;height:30px;padding:2px 10px;  font-size:22px;"
                        data-options="required:true, validateOnCreate:false, prompt:'输入密码',iconCls:'icon-lock',iconWidth:38, showEye:false">
                </td>
            </tr>
            <tr>
                <td>

                </td>
                <td style="padding:10px 0 10px 0px;">
                    <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" onclick="login()" style="padding:2px 0px;width:100%; -webkit-app-region: no-drag;">
                        登录
                    </a>
                </td>
            </tr>
        </table>
    </div>

    <div id="login_setting_panel" class="easyui-panel" data-options="border:false, fit:true, closed:true" style="width:100%;padding:10px 60px; margin-top:0px; text-align: center">

        <div>
            <div style="margin-top:30px; font-size:18px;">
                网络设置
            </div>
            <div style="margin:20px auto;-webkit-app-region: no-drag;">
                <input class="easyui-textbox" id="db_address_textbox" style="width:100%; padding:12px" label="数据库地址："
                    data-options="onChange:saveSetting">
            </div>
        </div>
    </div>

    <div id="login_failed_panel" class="easyui-panel" data-options="border:false, fit:true, closed:true" style="width:100%;padding:10px 60px; margin-top:0px; text-align: center">

        <div>
            <div style="margin-top:30px; font-size:18px;">
                你输入的账号或密码不正确，请重新登录。请注意区分大小写！
            </div>
            <div style="margin:20px auto;-webkit-app-region: no-drag;">
                <a class="easyui-linkbutton" onclick="returnToLogin()" style="width:100px;">返回</a>
            </div>
        </div>
    </div>

    <script>
        function changeUser(newvalue, oldvalue) {
            let data = $('#username').combobox('getData')
            let find = false;
            for (let i = 0; i < data.length; i++) {
                if (data[i].name.indexOf(newvalue) >= 0) {
                    find = true;
                    break;
                }
            }

            if (!find) {
                $('#username').combobox('hidePanel')
            }

        }


        var no;
        const { ipcRenderer } = require('electron')
        const win = require('electron').remote.getCurrentWindow();

        win.on('show', () => {

            loadLocalStorageUsers()
        })


        function closewin() {
            win.close();
        }

        function loadLocalStorageUsers() {
            let local_users = localStorage.getItem("local_users") || '[]'
            local_users = JSON.parse(local_users)

            let userComboData = []
            for (let i = 0; i < local_users.length; i++) {
                userComboData.push({ name: local_users[i] })
            }

            $('#username').combobox('loadData', userComboData)
            if (local_users.length > 0) {
                $('#username').combobox('setValue', local_users[0])
            }
        }


        $.parser.onComplete = function () {
            if (no) clearTimeout(no);
            no = setTimeout(completeLoading, 0);
        }

        function completeLoading() {
            win.show()
        }

        function login() {
            login_sccess = true

            let is_validate_username = $('#username').combobox('isValid')
            let is_validate_password = $('#password').passwordbox('isValid')
            if (!is_validate_username || !is_validate_password) {
                alert(false)
                return false
            }

            let user = $('#username').combobox('getValue')
            let password = $('#password').passwordbox('getValue')
            loginToDb(user, password, function (u) {
                if (u) {
                    localStorage.setItem('user', JSON.stringify(u))
                    let local_users = localStorage.getItem("local_users") || '[]'
                    local_users = JSON.parse(local_users)

                    local_users = $.grep(local_users, function (n, i) {
                        return n != user
                    });

                    local_users.unshift(user);
                    console.log('set local_users ' + local_users)
                    localStorage.setItem("local_users", JSON.stringify(local_users))

                    ipcRenderer.sendSync('login-success', null) // prints "pong"

                } else {
                    // show login error.
                    $('#login_form_panel').panel('close')
                    $('#setting_btn').css("visibility", "hidden")

                    $('#login_failed_panel').panel('open')
                }
            })
        }


        function loginToDb(username, password, callback) {
            UserModel.findOne({name: username, disabled: false }, function (err, u) {
                console.log(u)
                if (u.password == password) {
                    // login ok
                    callback(u)
                } else {
                    callback(null)
                }
            })

        }


        function returnToLogin() {
            $('#login_failed_panel').panel('close')
            $('#login_form_panel').panel('open')
            $('#setting_btn').css("visibility", "visible")
        }


        let isShowSetting = false;

        function showSetting() {
            if (isShowSetting) {
                isShowSetting = false;
                $('#login_setting_svg').hide();
                $('#login_setting_panel').panel('close')

                $('#login_form_svg').show();
                $('#login_form_panel').panel('open')
            } else {
                isShowSetting = true;
                $('#login_form_svg').hide();
                $('#login_form_panel').panel('close')

                $('#login_setting_svg').show();
                $('#db_address_textbox').textbox('setValue', localStorage.getItem("db_address"))
                $('#login_setting_panel').panel('open')

            }
        }


        function saveSetting() {
            localStorage.setItem("db_address", $('#db_address_textbox').textbox('getValue'))
        }


    </script>
</body>

</html>