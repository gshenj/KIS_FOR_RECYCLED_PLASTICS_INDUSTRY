<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>苏州元斌塑胶科技有限公司 KIS v1.0.0 </title>
    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }


    let DOCUMENT_TITLE = document.title;
    </script>
    <!-- normal script imports etc  -->
    <script src="./scripts/jquery-3.3.1.js"></script>
    <!-- Insert this line after script imports -->
    <script>if (window.module) module = window.module;</script>


    <link rel="stylesheet" type="text/css" href="./scripts/jquery-easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="./scripts/jquery-easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="./scripts/jquery-easyui/themes/color.css">
    <link rel="stylesheet" type="text/css" href="./scripts/DataTables/datatables.css">
    <link rel="stylesheet" type="text/css" href="./styles/kis.css">

    <script type="text/javascript" src="./scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery-easyui/datagrid-detailview.js"></script>
    <script type="text/javascript" src="./scripts/DataTables/datatables.js"></script>


    <script type="text/javascript" src="./scripts/DatagridEditor.js"></script>
    <script type="text/javascript" src="./user.js"></script>
    <script type="text/javascript" src="./customer.js"></script>
    <script type="text/javascript" src="./region.js"></script>
    <script type="text/javascript" src="./scripts/utils.js"></script>


    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
        }


    </style>

    <script>


        function set_tool_butoon_status(click_src) {
            $('.tool_button').linkbutton('enable')
            $(click_src).linkbutton('disable')
            document.title = DOCUMENT_TITLE + '　──　' + $(click_src).linkbutton('options').text + ''
        }

        function show_order_input(src) {
            hide_others()
            $('#order_input_panel').panel('open').panel('resize')
            $('#main_layout').layout('resize')
            // load_customer_grid();
            // $('#order_input_toolbar').show()

            set_tool_butoon_status(src)

        }

        function show_orders_list(src) {
            hide_others()
            $('#orders_grid_panel').panel('open').panel('resize')
            $('#main_layout').layout('resize')
            // load_customer_grid();

            set_tool_butoon_status(src)

        }


        function show_orders_chart(src) {

            set_tool_butoon_status(src)
        }

        function show_customer_manage(src) {
            hide_others()
            $('#customer_manage_panel').panel('open').panel('resize')
            $('#main_layout').layout('resize')
            //load_customer_grid();
            set_tool_butoon_status(src)
        }

        function show_product_manage(src) {
            hide_others()
            $('#product_manage_panel').panel('open').panel('resize')
            $('#main_layout').layout('resize')
            //load_customer_grid();
            set_tool_butoon_status(src)
        }

        function show_user_manage(src) {
            hide_others()
            $('#user_manage_panel').panel('open').panel('resize')
            $('#main_layout').layout('resize')
            // load_user_datagrid()
            set_tool_butoon_status(src)
        }


        function hide_others() {
            $('.opt_panel').panel('close')
            // $('.page_toolbar').hide()
        }


        function onOpenUserManagePanel() {
            // 加载角色树
            mongoose.getSysRoleTreeData(function (data) {
                let tree = $('#role_tree').tree('loadData', data)
                loadSysUsers(tree.tree("getRoot"))
            })
        }


        function loadSysUsers(node_selected) {
            let node = $('#role_tree').tree('getSelected')
            console.log('Call loadSysUsers')
            let params = {}
            let tree = $('#role_tree').tree()
            let rootNode = tree.tree('getRoot')
            if (node == null || rootNode == node) {
                console.log("Load all users")
            } else {

                let role = node.text
                console.log("Load users of " + role)
                params.role = role
            }

            console.log("params:" + JSON.stringify(params))
            loadSysUserGrid(params)
           /* mongoose.UserModel.find(params, function (err, users) {
                let d = users_to_grid(users)
                console.log(JSON.stringify(d))
                $('#sys_user_datagrid').datagrid('loadData', d)
            })*/
        }


        function onOpenCustomerManagePanel() {
            // 加载分类树
            loadClassifications(function (data) {
                $('#classification_tree').tree('loadData', data)
            })

            // 加载客户列表
            // loadCustomers(classification)
        }

        function save1() {
            saveClassifications($('#classification_tree').tree(), function () {
                alert('save ok')
            })
        }
    </script>
</head>
<body class="easyui-layout" id="main_layout" data-options="border:false"
      style="-webkit-app-region: drag; padding:0; margin:0;overflow-y: hidden;overflow-x: hidden">

<div data-options="region:'north',split:false, border:false"
     style="height:106px;width:100%; margin:0; padding:0;overflow-y: hidden;overflow-x: hidden">

    <div id="tt" class="easyui-tabs" data-options="tools:'#tab-tools', border:false"
         style="width:100%;height:106px; padding:0; margin:0;">
        <div title="送货单管理" data-options="iconCls:'icon-reload', border:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;  -webkit-user-select: none; ">
            <div style="float:left; width:60%; padding:0px;">
                <a class="easyui-linkbutton tool_button" style="-webkit-user-select: none;"
                   onclick="show_order_input(this)"
                   data-options="plain:true, iconCls:'icon-large-smartart', size:'large', iconAlign:'top'">单据填开</a>
                <a class="easyui-linkbutton tool_button" style="-webkit-user-select: none;"
                   onclick="show_orders_list(this)"
                   data-options="plain:true, iconCls:'icon-large-clipart', iconAlign:'top'">单据查询</a>
                <a class="easyui-linkbutton tool_button" style="-webkit-user-select: none;"
                   onclick="show_orders_chart(this)"
                   data-options="plain:true, iconCls:'icon-large-chart', iconAlign:'top'">统计报表</a>
            </div>
        </div>
        <div title="资料管理" data-options="closable:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;">
            <div style="float:left; width:60%; padding:0px;">
                <a class="easyui-linkbutton tool_button" onclick="show_customer_manage(this)"
                   data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">客户管理</a>

                <a class="easyui-linkbutton tool_button" onclick="show_product_manage(this)"
                   data-options="plain:true, iconCls:'icon-large-smartart', iconAlign:'top'">产品管理</a>

                <a class="easyui-linkbutton tool_button"
                   data-options="plain:true, iconCls:'icon-lorry',size:'large',iconAlign:'top'">司机管理</a>
            </div>

        </div>
        <div title="系统设置" data-options="closable:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;">
            <a class="easyui-linkbutton tool_button" onclick="show_user_manage(this)"
               data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">用户管理</a>
            <a class="easyui-linkbutton tool_button"
               data-options="plain:true, iconCls:'icon-large-smartart', iconAlign:'top'">系统参数</a>
        </div>
        <div title="我的账户" data-options="closable:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;">
            <a class="easyui-linkbutton"
               data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">密码重置</a>

        </div>
    </div>
    <div id="tab-tools" style="border:none;">
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add'"
           onclick="addPanel()"></a>
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-remove'"
           onclick="removePanel()"></a>
    </div>
</div>


<div data-options="region:'center', border:false"
     style="margin:0;padding:0px;background:#eee;overflow-y: hidden;overflow-x: hidden">

    <!--新开送货单-->
    <div id="order_input_panel" class="easyui-panel opt_panel" 　
         style="width:100%; height:100%; padding:0px 0px; background-color:#999; text-align:center; "
         data-options="fit:true,closed:true, border:false, onOpen:function(){alert('open')}">


        <div style="padding:0px 0px; border:0px solid red; width:850px;  margin:10px auto;  text-align:right;">
            <div id="order_input_toolbar"
                 style=" height:40px; line-height:40px; margin:0px auto 1px; background-color:#eee; padding:0px 10px; border:0px solid #bbb;  float:right;">
                <span style="">
                <a class="easyui-linkbutton" style=""
                   data-options="plain:true,iconCls:'icon-undo',iconAlign:'left'">重填</a>

                <a class="easyui-linkbutton" style=""
                   data-options="plain:true,iconCls:'icon-add',iconAlign:'left'">增行</a>

                <a class="easyui-linkbutton" style=""
                   data-options="plain:true,iconCls:'icon-remove',iconAlign:'left'">减行</a>

                <a class="easyui-linkbutton" style=""
                   data-options="plain:true,iconCls:'icon-print',iconAlign:'left'">打印</a>
                    </span>
                <div style="clear:both; height:1px; line-height:1px"></div>
            </div>

        </div>

        <div style="padding:20px 20px; border:0px dashed gray; width:810px; background-color:#fff; margin:0px auto ; clear:both;">


            <table class="bill_table">
                <tr>
                    <td style="text-align: center; padding:10px;"><span
                            style="font-size:26px;">苏州元斌塑胶科技有限公司 销售单</span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table class="bill_customer_table">
                            <tr>
                                <td>客户名称：<select id="cg" class="easyui-combogrid customer_combobox" name="dept"

                                                 data-options="
                                                panelWidth:450,
                                                value:'006',
                                                idField:'id',
                                                textField:'addr',
                                                onShowPanel:function(){},
                                                data:[],
                                                columns:[[
                                                     {field:'id',title:'ID',hidden:true,width:60},

                                                    {field:'code',title:'省份',width:60},
                                                    {field:'name',title:'城市',width:100},
                                                    {field:'addr',title:'名称',width:120}
                                                ]]
                                            "></select>
                                </td>
                                <td>送货日期：<input class="easyui-datebox sale_date" labelPosition="top"/></td>
                                <td>销售单号：<span id="sale_No" style="font-weight:bold;">20181012001</span></td>
                            </tr>
                            <tr>
                                <td>送货地址：<input name="email" class="customer_address easyui-textbox"/></td>
                                <td>联&nbsp;&nbsp;系&nbsp;&nbsp;人：<input name="n"
                                                                       class="principal easyui-textbox"/>
                                </td>
                                <td>联系电话：<input class="telephone easyui-textbox"/></td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table class="bill_product_table">
                            <tr>
                                <th>品名规格</th>
                                <th>单位</th>
                                <th>数量</th>
                                <th>单价</th>
                                <th>金额</th>
                                <th>备注</th>
                            </tr>
                            <tr>
                                <td class=""><select class="product_name easyui-combobox " name="state">
                                    <option value="AL">Alabama</option>
                                </select></td>
                                <td class=""><input class="product_units easyui-textbox"/></td>
                                <td class=""><input class="product_num easyui-textbox"/></td>
                                <td class=""><input class="product_price easyui-textbox"/></td>
                                <td class=""><input class="product_sum easyui-textbox"/></td>
                                <td class=""><input class="product_memo easyui-textbox"/></td>
                            </tr>
                            <tr>
                                <td class=""><select class="product_name easyui-combobox " name="state">
                                    <option value="AL">Alabama</option>
                                </select></td>
                                <td class=""><input class="product_units easyui-textbox"/></td>
                                <td class=""><input class="product_num easyui-textbox"/></td>
                                <td class=""><input class="product_price easyui-textbox"/></td>
                                <td class=""><input class="product_sum easyui-textbox"/></td>
                                <td class=""><input class="product_memo easyui-textbox"/></td>
                            </tr>
                            <tr>
                                <td class=""><select class="product_name easyui-combobox " name="state">
                                    <option value="AL">Alabama</option>
                                </select></td>
                                <td class=""><input class="product_units easyui-textbox"/></td>
                                <td class=""><input class="product_num easyui-textbox"/></td>
                                <td class=""><input class="product_price easyui-textbox"/></td>
                                <td class=""><input class="product_sum easyui-textbox"/></td>
                                <td class=""><input class="product_memo easyui-textbox"/></td>
                            </tr>
                            <tr>
                                <td class=""><select class="product_name easyui-combobox " name="state">
                                    <option value="AL">Alabama</option>
                                </select></td>
                                <td class=""><input class="product_units easyui-textbox"/></td>
                                <td class=""><input class="product_num easyui-textbox"/></td>
                                <td class=""><input class="product_price easyui-textbox"/></td>
                                <td class=""><input class="product_sum easyui-textbox"/></td>
                                <td class=""><input class="product_memo easyui-textbox"/></td>
                            </tr>

                            <tr>
                                <td colspan="6" style="text-align: right;font-weight: bold;">合计金额：
                                    <span id="product_total_sum" style="margin-right: 20%;"></span>
                                </td>
                            </tr>

                        </table>

                    </td>
                </tr>
                <tr>
                    <td>
                        <table class="bill_user_table">
                            <td>制单人：<input class="f1 easyui-textbox"></input></td>
                            <td>送货司机：<select class="easyui-combobox" name="state1"
                                             style="width:150px;"></select></td>
                            <td>签收人：<input class="f1 easyui-textbox" disabled></input></td>
                        </table>
                    </td>
                </tr>
                <!--  <tr>
                      <td style="text-align: right; padding:20px">
                          <a href="#" style="width:100px;" class="easyui-linkbutton"
                             data-options="iconCls:'icon-save'">保存</a>
                      </td>
                  </tr>-->

            </table>
        </div>
    </div>


    <!--送货单列表-->
    <div id="orders_grid_panel" class="easyui-panel opt_panel" style="width:100%; height:100%; "
         data-options="fit:true, closed:true">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul class="easyui-tree" data-options="lines:true">
                    <li>
                        <span>区域选择</span>
                        <ul>
                            <li><span><a href="#">管理员</a></span></li>
                            <li><span><a href="#">操作员</a></span></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div data-options="region:'center'" style="padding:4px;">

                <table class="easyui-datagrid " style="width:100%">
                </table>
            </div>
        </div>

    </div>

    <!--客户管理-->
    <div id="customer_manage_panel" class="easyui-panel opt_panel" style="width:100%; height:100%; "
         data-options="fit:true, closed:true, onOpen:onOpenCustomerManagePanel">
        <button onclick="save1()">save</button>
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul id="classification_tree" class="easyui-tree" data-options="lines:true,
                onClick: function(node){
                    $(this).tree('beginEdit',node.target);},
onContextMenu: function(e,node){
                    e.preventDefault();
                    $(this).tree('select',node.target);
                    $('#mm').menu('show',{
                        left: e.pageX,
                        top: e.pageY
                    });
                }
">

                </ul>

                <div id="mm" class="easyui-menu" style="width:120px;">
                    <div onclick="append()" data-options="iconCls:'icon-add'">Append</div>
                    <div onclick="removeit()" data-options="iconCls:'icon-remove'">Remove</div>
                    <div class="menu-sep"></div>
                    <div onclick="expand()">Expand</div>
                    <div onclick="collapse()">Collapse</div>
                </div>

                <script type="text/javascript">
                    function append() {
                        var t = $('#classification_tree');
                        var node = t.tree('getSelected');
                        t.tree('append', {
                            parent: (node ? node.target : null),
                            data: [{
                                text: 'new item1'
                            }, {
                                text: 'new item2'
                            }]
                        });
                    }

                    function removeit() {
                        var node = $('#classification_tree').tree('getSelected');
                        $('#classification_tree').tree('remove', node.target);
                    }

                    function collapse() {
                        var node = $('#classification_tree').tree('getSelected');
                        $('#classification_tree').tree('collapse', node.target);
                    }

                    function expand() {
                        var node = $('#classification_tree').tree('getSelected');
                        $('#classification_tree').tree('expand', node.target);
                    }
                </script>
            </div>


            <div data-options="region:'center'" style="padding:4px;">

                <table id="customer_grid" class="display" style="width:100%">
                </table>
            </div>
        </div>

    </div>

    <!--产品管理-->
    <div id="product_manage_panel" class="easyui-panel opt_panel" style="width:100%; height:100%; "
         data-options="fit:true, closed:true">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                选择客户：<input class="easyui-combobox"/>


                <div style="width:100px; height:100px;">
                    客户信息
                </div>
            </div>
            <div data-options="region:'center'" style="padding:4px;">
                <table id="product_grid" class="easyui-datagrid" style="width:100%">
                </table>
            </div>
        </div>

    </div>

    <script type="text/javascript">

/*

        let editIndex = undefined;

        function endEditing() {
            if (typeof(editIndex) == 'undefined') {
                return true
            }
            if (PRODUCT_GRID.datagrid('validateRow', editIndex)) {
                PRODUCT_GRID.datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }

        function onClickCell(index, field) {
            if (editIndex != index) {
                if (endEditing()) {
                    PRODUCT_GRID.datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                    var ed = PRODUCT_GRID.datagrid('getEditor', {index: index, field: field});
                    if (ed) {
                        ($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
                    }
                    editIndex = index;
                } else {
                    setTimeout(function () {
                        PRODUCT_GRID.datagrid('selectRow', editIndex);
                    }, 0);
                }
            }
        }

        function onEndEdit(index, row) {
            var ed = $(this).datagrid('getEditor', {
                index: index,
                field: 'name'
            });
            row.name = $(ed.target).combobox('getText');
        }

        function append() {
            if (endEditing()) {
                PRODUCT_GRID.datagrid('appendRow', {status: 'P'});
                editIndex = PRODUCT_GRID.datagrid('getRows').length - 1;
                PRODUCT_GRID.datagrid('selectRow', editIndex)
                    .datagrid('beginEdit', editIndex);
            }
        }

        function removeit() {
            if (editIndex == undefined) {
                return
            }
            PRODUCT_GRID.datagrid('cancelEdit', editIndex)
                .datagrid('deleteRow', editIndex);
            editIndex = undefined;
        }

        function accept() {
            if (endEditing()) {
                PRODUCT_GRID.datagrid('acceptChanges');
                return true;
            }
            return false;
        }

        function reject() {
            PRODUCT_GRID.datagrid('rejectChanges');
            editIndex = undefined;
        }

        function getChanges() {
            var rows = PRODUCT_GRID.datagrid('getChanges');
            alert(rows.length + ' rows are changed!');
        }

*/









        var editIndex1 = undefined;
       /* function endEditing(){
            if (editIndex1 == undefined){return true}
            if ($('#sys_user_datagrid').datagrid('validateRow', editIndex1)){
                $('#sys_user_datagrid').datagrid('endEdit', editIndex1);
                editIndex1 = undefined;
                return true;
            } else {
                return false;
            }
        }
        function onClickCell1(index, field){
            if (editIndex1 != index){
                if (endEditing()){
                    $('#sys_user_datagrid').datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                    var ed = $('#sys_user_datagrid').datagrid('getEditor', {index:index,field:field});
                    if (ed){
                        ($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
                    }
                    editIndex1 = index;
                } else {
                    setTimeout(function(){
                        $('#sys_user_datagrid').datagrid('selectRow', editIndex1);
                    },0);
                }
            }
        }
        function onEndEdit1(index, row){
            var ed = $(this).datagrid('getEditor', {
                index: index,
                field: 'role'
            });
            row.productname = $(ed.target).combobox('getText');
        } */

function endEditing() {
    if (typeof(editIndex) == 'undefined') {
        return true
    }
    if (PRODUCT_GRID.datagrid('validateRow', editIndex)) {
        PRODUCT_GRID.datagrid('endEdit', editIndex);
        editIndex = undefined;
        return true;
    } else {
        return false;
    }
}

        function append1(){
                $('#sys_user_datagrid').datagrid('appendRow',{});
                editIndex1 = $('#sys_user_datagrid').datagrid('getRows').length-1;
                $('#sys_user_datagrid').datagrid('selectRow', editIndex1)
                    .datagrid('beginEdit', editIndex1);
       //     $('.user_grid_btn').linkbutton('disable')
         //   $('#btn_accept').linkbutton('enable')
          //  $('#btn_reject').linkbutton('enable')
        }

        function removeit1(){
            let selRow =  $('#sys_user_datagrid').datagrid('getSelected')
            if (selRow == null) {
                alert('请选择')
            } else {
                //删数据库， 回调中
                editIndex1 = $('#sys_user_datagrid').datagrid('getRowIndex', selRow)
                $('#sys_user_datagrid').datagrid('deleteRow', editIndex1);
                editIndex1 = undefined;
            }

        }

        function accept1(){

            $('#sys_user_datagrid').datagrid('acceptChanges');

           /* if (typeof(editIndex1) != 'undefined'){
                $('#sys_user_datagrid').datagrid('acceptChanges');

            } else {
                // do nothing
            }*/

        }
        function reject1(){
            $('#sys_user_datagrid').datagrid('rejectChanges');
            editIndex1 = undefined;
           // $('.user_grid_btn').linkbutton('enable')
            //$('#btn_accept').linkbutton('disable')

        }
        function getChanges1(){
            var rows = $('#sys_user_datagrid').datagrid('getChanges');
            console.log(JSON.stringify(rows));
        }



        function edit1(src) {
           let selRow =  $('#sys_user_datagrid').datagrid('getSelected')
               if (selRow == null) {
                   alert('请选择')
               } else {
                   editIndex1 = $('#sys_user_datagrid').datagrid('getRowIndex', selRow)
                   $('#sys_user_datagrid').datagrid('beginEdit', editIndex1)
                //   $('.user_grid_btn').linkbutton('enable')

                  // $('#btn_edit').linkbutton('disable')
                   //$('#btn_append').linkbutton('disable')
                   //$('#btn_delete').linkbutton('disable')

               }

        }

    </script>

    <!--登录用户管理-->
    <div id="user_manage_panel" class="easyui-panel opt_panel" style="width:100%; height:100%; "
         data-options="fit:true, border:false, closed:true, onOpen:onOpenUserManagePanel">
        <div class="easyui-layout" data-options="fit:true, border:false">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul id="role_tree" class="easyui-tree" data-options="lines:true,onSelect:loadSysUsers">

                </ul>
            </div>
            <div data-options="region:'center'" style="padding:0px;">
                <table id="sys_user_datagrid"></table>
                <div id="dlg" class="easyui-dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons'">
                    <form id="fm" method="post" novalidate style="margin:0;padding:20px 50px">
                        <div style="margin-bottom:10px">
                            <input name="name" id="name_textbox" class="easyui-textbox" required="true" label="用&nbsp;&nbsp;户&nbsp;&nbsp;名:" labelAlign="right" style="width:100%">
                            <input name="_id" id="user_id" type="hidden"/>
                        </div>
                        <div style="margin-bottom:10px">
                            <input name="role" id="role_combobox" class="easyui-combobox" required="true" label="角&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;色:" labelAlign="right" style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">

                            <input id="disabled_checkbox" class="easyui-checkbox" name="disabled" labelAlign="right" label="禁&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用:">

                        </div>
                    </form>
                </div>
                <div id="dlg-buttons">
                    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveUser()" style="width:90px">Save</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width:90px">Cancel</a>
                </div>

                <script type="text/javascript">

                    SYS_USER_GRID = null;

                    var toolbar01 = [
                        {
                            text: '添加',
                            iconCls: 'icon-add',
                            handler: function () {
                                // show_sys_user_form('add')
                                newUser()
                            }
                        }, {
                        text: '编辑',
                        iconCls: 'icon-edit',
                        handler: function () {
                            editUser()
                        }
                    }, {
                        text: '删除',
                        iconCls: 'icon-remove',
                        handler: function () {
                            destroyUser()
                            // show_sys_user_form('delete')
                        }
                    }, {
                        text: '重置密码',
                        iconCls: 'icon-lock',
                        handler: function () {
                            resetPassword()
                            // show_sys_user_form('reset_pass')
                        }
                    }]



                    function loadSysUserGrid(params) {
                        if (SYS_USER_GRID == null) {
                            // first time
                            console.log("first time load sys user grid.")
                            SYS_USER_GRID = $('#sys_user_datagrid').datagrid({
                                fit: true,
                                singleSelect: true,
                                collapsible: false,
                                data: [],
                                border:false,
                                width:700,
                                height:500,
                                toolbar: toolbar01,
                                columns:[[
                                    {field:'name',title:'用户名',width:100},
                                    {field:'role',title:'角色',width:100},
                                    {field:'disabled',title:'状态',width:100,align:'right', formatter: function(value,row,index){
                                            if (row.disabled){
                                                return "<span style='color:red'>禁用</span>";
                                            } else {
                                                return "启用";
                                            }
                                        }}
                                ]]
                            })
                        }

                        mongoose.UserModel.find(params, function (err, users) {
                            //console.log("Load users: " +JSON.stringify(users))
                            SYS_USER_GRID.datagrid('loadData', users)
                        })
                    }


                    var url;
                    function newUser(){
                        $('#dlg').dialog('open').dialog('center').dialog('setTitle','New User');
                        $('#fm').form('clear');
                       // url = 'save_user.php';
                        url = 'new'
                    }
                    function editUser(){
                        var row = $('#sys_user_datagrid').datagrid('getSelected');
                        if (row){
                            $('#dlg').dialog('open').dialog('center').dialog('setTitle','Edit User');
                            console.log("ROw"+JSON.stringify(row))
                            $('#fm').form('load',row);
                            if (row.disabled) {
                                $('#disabled_checkbox').checkbox('check')
                            } else {
                                $('#disabled_checkbox').checkbox('uncheck')
                            }
                           // url = 'update_user.php?id='+row.id;
                            url = 'edit'
                        }
                    }

                    function saveUser(){

                        let name = $('#name_textbox').textbox('getValue')
                        let role = $('#role_combobox').combobox('getText')
                        let disabled = $('#disabled_checkbox').checkbox('options').checked



                        let user = {name: name, role: role, disabled:disabled}
                        console.log("New user is: "+JSON.stringify(user))
                        if (url == 'new') {
                            addUser(user, function() {
                                $('#dlg').dialog('close');
                                loadSysUsers(null)
                            })

                        } else if (url == 'edit') {
                            let user_id = $('#user_id').val();
                            user._id = user_id;
                            updateUser(user, function(){
                                $('#dlg').dialog('close');
                                loadSysUsers(null)
                            })
                        }



/*
                        $('#fm').form('submit',{
                            url: url,
                            onSubmit: function(){

                                let isDisabled = $('#disabled_switchbtn').swithbutton('checked')


                                return $(this).form('validate');
                            },
                            success: function(result){
                                var result = eval('('+result+')');
                                if (result.errorMsg){
                                    $.messager.show({
                                        title: 'Error',
                                        msg: result.errorMsg
                                    });
                                } else {
                                    $('#sys_user_datagrid').dialog('close');        // close the dialog
                                    $('#dg').datagrid('reload');    // reload the user data
                                }
                            }
                        });*/
                    }
                    function destroyUser(){
                        var row = $('#sys_user_datagrid').datagrid('getSelected');
                        if (row){
                            $.messager.confirm('确定','是否确定删除选中的用户?',function(r){
                                if (r){

                                    deleteUser({_id:row._id},function(){
                                        $('#dlg').dialog('close');
                                        loadSysUsers(null)
                                    })

                                }
                            });
                        }
                    }

                    function resetPassword() {
                        var row = $('#sys_user_datagrid').datagrid('getSelected');
                        if (row){
                            $.messager.confirm('确定','是否确定重置选中的用户的登录密码?',function(r){
                                if (r){
                                    resetUserPassword({_id:row._id},function(){
                                        $('#dlg').dialog('close');
                                        loadSysUsers(null)
                                    })

                                }
                            });
                        }
                    }

                </script>
            </div>
        </div>

    </div>


</div>


</body>
</html>