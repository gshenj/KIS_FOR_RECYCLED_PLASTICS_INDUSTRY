<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>苏州元斌塑胶科技有限公司 KIS v1.0.0 </title>
    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }


    let DOCUMENT_TITLE = document.title;
    </script>
    <!-- normal script imports etc  -->
    <script src="./scripts/jquery-3.3.1.js"></script>
    <!-- Insert this line after script imports -->
    <script>
        if (window.module)
            module = window.module;

    </script>


    <link rel="stylesheet" type="text/css" href="./scripts/jquery-easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="./scripts/jquery-easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="./scripts/jquery-easyui/themes/color.css">
    <link rel="stylesheet" type="text/css" href="./scripts/DataTables/datatables.css">
    <!--<link rel="stylesheet" type="text/css" href="./scripts/bootstrap4/css/bootstrap.css">-->
    <link rel="stylesheet" type="text/css" href="./styles/kis.css">

    <script type="text/javascript" src="./scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery-easyui/locale/easyui-lang-zh_CN.js"></script>
    <!--<script type="text/javascript" src="./scripts/jquery-easyui/datagrid-detailview.js"></script>-->
    <!--<script type="text/javascript" src="./scripts/DataTables/datatables.js"></script>-->
    <!--<script type="text/javascript" src="./scripts/bootstrap4/js/bootstrap.js"></script>-->


    <!--<script type="text/javascript" src="./scripts/DatagridEditor.js"></script>-->
    <script type="text/javascript" src="./scripts/kis.js"></script>
    <script type="text/javascript" src="./user.js"></script>
    <script type="text/javascript" src="./customer.js"></script>
    <script type="text/javascript" src="./scripts/product.js"></script>
    <script type="text/javascript" src="scripts/classification.js"></script>
    <script type="text/javascript" src="./scripts/utils.js"></script>
    <script type="text/javascript" src="./scripts/loading.js"></script>
    <script type="text/javascript" src="./scripts/sale_order.js"></script>


    <script type="text/javascript" src="./scripts/jquery-easyui/plugins/datagrid-export/datagrid-export.js"></script>
    <script type="text/javascript" src="./scripts/jquery-easyui/plugins/datagrid-filter/datagrid-filter.js"></script>
    <script type="text/javascript" src="./scripts/jquery-easyui/plugins/datagrid-groupview.js"></script>


    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
        }

        .radio_label {
            font-weight: bold;
            border: 0px solid black;
            width: 100%;
        }

        .product_choose_textbox:hover .textbox-icon {
            opacity: 1.0;
            filter: alpha(opacity=100);
            background: url('scripts/jquery-easyui/themes/icons/pencil.png') no-repeat center center;
        }
    </style>

    <script>


        $.extend($.fn.textbox.methods, {
            addClearBtn: function (jq, iconCls) {
                return jq.each(
                    function () {
                        var t = $(this);
                        //console.log("t======" + JSON.stringify(t))
                        var opts = t.textbox('options');
                        opts.icons = []//opts.icons || [];  fixed
                        opts.icons.unshift({
                            iconCls: iconCls,
                            handler: function (e) {
                                // console.log("Before clear:" + $(e.data.target).textbox('getText') + "-" + $(e.data.target).textbox('getValue'))
                                $(e.data.target).textbox('clear').textbox('setText', '')//.textbox('textbox').focus();
                                $(this).css('visibility', 'hidden');
                                // console.log("After clear:" + $(e.data.target).textbox('getText') + "-" + $(e.data.target).textbox('getValue'))

                                if (customer_choose_dlg_type == 'list_products') {
                                    loadProducts()
                                } else if (customer_choose_dlg_type == 'new_order') {
                                    resetOrder()
                                }
                            }
                        });
                        t.textbox();
                        if (!t.textbox('getText')) {
                            t.textbox('getIcon', 0).css('visibility', 'hidden');
                        }
                        t.textbox('textbox').bind('keyup', function () {
                            var icon = t.textbox('getIcon', 0);
                            if ($(this).val()) {
                                icon.css('visibility', 'visible');
                            } else {
                                icon.css('visibility', 'hidden');
                            }
                        });
                    }
                );
            }
        });

        $(function () {
            $('#customer_choose_for_product_manage').textbox('addClearBtn', 'icon-clear');
            $('#customer_choose_for_product_manage').textbox('textbox').bind('focus', function (e) {
                customer_choose_dlg_type = 'list_products'
                $('#dlg_for_customer_choose').dialog('open').dialog('center')
            });
            $('#new_order_customer_name').textbox('addClearBtn', 'icon-clear');
            $('#new_order_customer_name').textbox('textbox').bind('focus', function (e) {
                customer_choose_dlg_type = 'new_order'
                $('#dlg_for_customer_choose').dialog('open').dialog('center')
            });


        });
    </script>

</head>
<body class="easyui-layout" id="main_layout" data-options="border:false"
      style="-webkit-app-region: drag; padding:0; margin:0;overflow-y: hidden;overflow-x: hidden; height:100%">

<div data-options="region:'north',split:false, border:false"
     style="height:106px;width:100%; margin:0; padding:0;overflow-y: hidden;overflow-x: hidden">

    <div id="tt" class="easyui-tabs" data-options="border:false"
         style="width:100%;height:106px; padding:0; margin:0;">

        <div title="送货单管理" data-options="border:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;  -webkit-user-select: none; ">
            <div style="float:left; width:60%; padding:0px;">
                <a class="easyui-linkbutton tool_button" style="-webkit-user-select: none;"
                   onclick="show_panel(this, 'order_input_panel')"
                   data-options="plain:true, iconCls:'icon-large-smartart', size:'large', iconAlign:'top'">单据填开</a>
                <a id="order_list_menu" class="easyui-linkbutton tool_button" style="-webkit-user-select: none;"
                   onclick="show_panel(this, 'orders_grid_panel')"
                   data-options="plain:true, iconCls:'icon-large-clipart', iconAlign:'top'">单据查询</a>
                <a class="easyui-linkbutton tool_button" style="-webkit-user-select: none;"
                   onclick="show_panel(this, 'order_report_panel')"
                   data-options="plain:true, iconCls:'icon-large-chart', iconAlign:'top'">统计报表</a>
            </div>
        </div>

        <div title="资料管理" data-options="closable:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;">
            <div style="float:left; width:60%; padding:0px;">
                <a class="easyui-linkbutton tool_button" onclick="show_panel(this, 'customer_manage_panel')"
                   data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">客户管理</a>

                <a class="easyui-linkbutton tool_button" onclick="show_panel(this, 'product_manage_panel')"
                   data-options="plain:true, iconCls:'icon-large-smartart', iconAlign:'top'">产品管理</a>

                <a class="easyui-linkbutton tool_button" onclick="show_panel(this, 'driver_manage_panel')"
                   data-options="plain:true, iconCls:'icon-lorry',size:'large',iconAlign:'top'">司机管理</a>
            </div>
        </div>

        <div title="系统设置" data-options="closable:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;">
            <a class="easyui-linkbutton tool_button" onclick="show_panel(this, 'user_manage_panel')"
               data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">用户管理</a>
            <a class="easyui-linkbutton tool_button" onclick="show_panel(this, 'sys_config_panel')"
               data-options="plain:true, iconCls:'icon-large-smartart', iconAlign:'top'">系统参数</a>
        </div>

        <div title="我的账户" data-options="closable:false" style="background:-webkit-gradient(linear, 0 0, 0 bottom, from(#ffffff), to(#eaedf1));
	padding:4px;">
            <a class="easyui-linkbutton tool_button" onclick="show_panel(this, 'password_set_panel')"
               data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">密码设置</a>
            <a class="easyui-linkbutton tool_button" onclick="logout()"
               data-options="plain:true, iconCls:'icon-large-smartart',iconAlign:'top'">退出系统</a>
        </div>
    </div>
</div>


<div data-options="region:'center', border:false"
     style="margin:0;padding:0px;background:#eee;overflow-y: hidden;overflow-x: hidden">

    <!--新开送货单-->
    <div id="order_input_panel" class="easyui-panel opt_panel"　
         style="width:100%; height:100%; padding:0px 0px; background-color:#999; text-align:center; "
         data-options="fit:true,closed:true, border:false, onOpen:resetOrder">

        <div style="padding:0px 0px; border:0px solid red; width:850px;  margin:10px auto;  text-align:right;">
            <div id="order_input_toolbar"
                 style=" height:40px; line-height:40px; margin:0px auto 1px; background-color:#eee; padding:0px 10px; border:0px solid #bbb;  float:right;">
                <span style="">
                <a class="easyui-linkbutton" style="" onclick="resetOrder()"
                   data-options="plain:true,iconCls:'icon-undo',iconAlign:'left'">重填</a>

                <a class="easyui-linkbutton" style="" onclick="addOrderRow()"
                   data-options="plain:true,iconCls:'icon-add',iconAlign:'left'">增行</a>

                <a class="easyui-linkbutton" style="" onclick="deleteOrderRow()"
                   data-options="plain:true,iconCls:'icon-remove',iconAlign:'left'">减行</a>

                <a class="easyui-linkbutton" style="" onclick="doPrint()"
                   data-options="plain:true,iconCls:'icon-print',iconAlign:'left'">打印</a>
                    </span>
                <div style="clear:both; height:1px; line-height:1px"></div>
            </div>
        </div>

        <script>

            function resetOrder() {
                $('#new_order_form').form('clear')

                //
                getCurrentSeq("order_seq", function(value){
                    $('#new_order_sale_No').html(value+1)
                })



                //
                let t = $('#new_order_customer_name')
                if (!t.textbox('getText')) {
                    t.textbox('getIcon', 0).css('visibility', 'hidden');
                }
                //
                $('#new_order_sale_date').datebox('setValue', myDateFormatter(new Date()))
                //
                resetOrderProductGrid(false)
            }

            function resetOrderProductGrid(addFirstRow) {
                deleteAllRows()
                if (addFirstRow) {
                    addOrderRow()
                }
            }

            function endEditing() {
                if (typeof(editIndex) == 'undefined') {
                    return true
                }
                if ($('#order_products_grid').datagrid('validateRow', editIndex)) {
                    $('#order_products_grid').datagrid('endEdit', editIndex);
                    editIndex = undefined;
                    return true;
                } else {
                    return false;
                }
            }


            function deleteOrderRow() {

                removeit()
            }


            function addOrderRow() {
                if (endEditing()) {
                    let rows = $('#order_products_grid').datagrid('getRows');
                    if (rows.length == 0 || rows.length == 1) {
                        // 如果当面没有行，或者只有1行，那么追加一行
                        $('#order_products_grid').datagrid('appendRow', {});
                        editIndex = $('#order_products_grid').datagrid('getRows').length - 1;

                    } else {
                        let selectedRow = $('#order_products_grid').datagrid('getSelected');
                        if (selectedRow) {
                            console.log(JSON.stringify(selectedRow))
                            let selectedIndex = $('#order_products_grid').datagrid('getRowIndex', selectedRow);
                            if (selectedIndex == (rows.length - 1)) {
                                // 不管多少行，如果当前选中最后一行，添加最后一行
                                $('#order_products_grid').datagrid('appendRow', {});
                                editIndex = $('#order_products_grid').datagrid('getRows').length - 1;
                            } else {
                                // 否则在选中行之前插入一行
                                console.log("selectedINdex" + selectedIndex)
                                $('#order_products_grid').datagrid("insertRow", {index: selectedIndex, row: {}})
                                editIndex = selectedIndex;
                            }

                        } else {
                            //如果当前没有选中任何一行，那么在尾部添加一行，正常不会执行到这里
                            $('#order_products_grid').datagrid('appendRow', {});
                            editIndex = $('#order_products_grid').datagrid('getRows').length - 1;
                        }
                    }

                    // editIndex = $('#order_products_grid').datagrid('getRows').length - 1;

                    $('#order_products_grid').datagrid('selectRow', editIndex)
                        .datagrid('beginEdit', editIndex);
                }
            }

            function removeit() {
                if (editIndex == undefined) {
                    return
                }
                $('#order_products_grid').datagrid('cancelEdit', editIndex)
                    .datagrid('deleteRow', editIndex);
                editIndex = undefined;
            }

            function deleteAllRows() {
                let rows = $('#order_products_grid').datagrid('getRows')
                for (let i = rows.length; i > 0;) {
                    i--;
                    $('#order_products_grid').datagrid('cancelEdit', i).datagrid('deleteRow', i)
                }
                editIndex = undefined
            }

            function onClickCell(index, field, value) {

                console.log("onClickCell")
                if (editIndex != index) {
                    if (endEditing()) {
                        $('#order_products_grid').datagrid('selectRow', index)
                            .datagrid('beginEdit', index);
                        var ed = $('#order_products_grid').datagrid('getEditor', {index: index, field: field});
                        if (ed) {
                            ($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
                        }
                        editIndex = index;
                    } else {
                        setTimeout(function () {
                            $('#order_products_grid').datagrid('selectRow', editIndex);
                        }, 0);
                    }
                }
            }

            function accept() {
                if (endEditing()) {
                    $('#order_products_grid').datagrid('acceptChanges');
                }
            }

            function doPrint() {
                accept();

                let products = $('#order_products_grid').datagrid('getRows')

                // save orders
                let customer_id = $('#new_order_customer_name').textbox('getValue');
                let customer_name = $('#new_order_customer_name').textbox('getText');
                let order_date = $('#new_order_sale_date').textbox('getText');
                //let order_num = $('#new_order_sale_No').textbox('getValue')
                let delivery_address = $('#new_order_customer_address').textbox('getValue')
                let principal = $('#new_order_customer_principal').textbox('getValue')
                let contact_number = $('#new_order_customer_phone').textbox('getValue')
                let maker = $('#new_order_maker').textbox('getValue')
                let driver = $('#driver_select').textbox('getValue')
                let cancelled = false;

                let products_num;
                let products_sum;

                let order_data = {
                    order_num: 1,//order_num,
                    customer_id: customer_id,
                    customer_name: customer_name,
                    customer_principal: principal,
                    contact_number: contact_number,
                    delivery_address: delivery_address,
                    order_date: order_date,
                    order_maker: maker,
                    order_driver: driver,
                    cancelled: cancelled,
                    products: products
                    //create_user:  current_user
                }

                console.log(JSON.stringify(order_data))
                $('#win_in').html('正在保存出库单...')
                $('#win').window('open')

                setTimeout(function () {
                    saveOrder(order_data, function (doc) {
                        $('#win_in').html('开始打印...')

                        require('electron').remote.getGlobal('globalObj').order_id = mongoose.Types.ObjectId(doc._id).toString()

                        console.log(require('electron').remote.getGlobal('globalObj').order_id)
                        setTimeout(function () {
                            printit()
                            //$('#win').window('close')
                            //关闭打印页面，window消失
                        }, 1000)
                    })
                }, 1000)
            }


        </script>
        <div style="padding:20px 20px; border:0px dashed gray; width:810px; background-color:#fff; margin:0px auto ; clear:both;">
            <div style="width:100%">
                <form id="new_order_form">
                    <div style="text-align: center; padding:10px;"><span
                            style="font-size:26px;margin:0 auto;">苏州元斌塑胶科技有限公司 销售单</span></div>
                    <table class="bill_customer_table">
                        <tr>
                            <td>客户名称：<input id="new_order_customer_name" class="easyui-textbox customer_name"
                            />
                            </td>
                            <td>送货日期：<input id="new_order_sale_date"
                                            class="easyui-datebox sale_date"
                                            data-options="editable:false, formatter:myDateFormatter"
                                            value="new Date()"
                                            labelPosition="top"/>
                            </td>
                            <td>销售单号：<span id="new_order_sale_No" style="font-weight:bold;"></span>
                                <!--<input type="hidden" id="new_order_sale_No" />-->
                            </td>
                        </tr>
                        <tr>
                            <td>送货地址：<input id="new_order_customer_address" class="customer_address easyui-textbox"/>
                            </td>
                            <td>联&nbsp;&nbsp;系&nbsp;&nbsp;人：<input id="new_order_customer_principal"
                                                                   class="principal easyui-textbox"/>
                            </td>
                            <td>联系电话：<input id="new_order_customer_phone" class="telephone easyui-textbox"/></td>
                        </tr>
                    </table>

                    <table id="order_products_grid" class="easyui-datagrid" style="maring-top:20px;"
                           data-options="height:202,data:[],singleSelect:true,
onClickCell: onClickCell,style:{marginTop:20}">
                        <thead>
                        <tr>
                            <th data-options="field:'product_name', align:'left', halign:'center',width:248,editor:{
                            type:'textbox',
                            options:{
                                prompt: '',
                                cls:'product_choose_textbox',
                                iconWidth: 22,
                                icons: [{
                                    iconCls:'icon-blank',
                                    handler: function(e){
                                        $('#dlg_for_product_choose').dialog('open').dialog('center');
                                    }
                                }]
                            }
                        }">品名规格
                            </th>
                            <th data-options="field:'product_units', align:'center', halign:'center', width:80, editor:'textbox'">
                                单位
                            </th>
                            <th data-options="field:'product_num', align:'center', halign:'center', width:100, editor:'textbox'">
                                数量
                            </th>
                            <th data-options="field:'product_price', align:'center', halign:'center', width:80, editor:{type:'numberbox',options:{precision:2}}">
                                单价
                            </th>
                            <th data-options="field:'product_sum', align:'center', halign:'center', width:100, editor:{type:'numberbox',options:{precision:2}}">
                                金额
                            </th>
                            <th data-options="field:'product_memo', align:'left', halign:'center', width:200, editor:'textbox'">
                                备注
                            </th>
                        </tr>
                        </thead>
                        <tr>
                            <td colspan="6" style="text-align: right;font-weight: bold;">合计金额：
                                <span id="product_total_sum" style="margin-right: 20%;"></span>
                            </td>
                        </tr>
                    </table>

                    <table class="bill_user_table">
                        <td>制单人：<input id="new_order_maker" class="f1 easyui-textbox"></input></td>
                        <td>送货司机：<select class="easyui-combogrid" id="driver_select"
                                         data-options="onShowPanel:onShowDriverPanel,
                                    panelWidth: 810,
                                    panelMaxHeight:220,
                                    idField: 'name',
                                    textField: 'name',
                                    data:[],
                                    columns: [[
                                        {field:'name',title:'司机',width:90, align:'left', halign:'center'},
                                        {field:'car_type',title:'车型载重',width:110, align:'left', halign:'center'},
                                        {field:'car_No',title:'车牌号',width:90, align:'left', halign:'center'},
                                        {field:'driving_license_No',title:'行驶证号',width:110, align:'left', halign:'center'},
                                        {field:'id_No',title:'身份证号',width:110, align:'left', halign:'center'},
                                        {field:'phone',title:'电话',width:90, align:'left', halign:'center'},
                                        {field:'address',title:'地址',width:200, align:'left', halign:'center'}
                                    ]]" style="width:150px;"></select>
                        </td>
                        <td>签收人：<input class="f1 easyui-textbox" disabled></input></td>
                    </table>

                </form>
            </div>

        </div>
    </div>

    <!--送货单列表-->
    <div id="orders_grid_panel" class="easyui-panel opt_panel" style="width:100%; height:100%; "
         data-options="fit:true, closed:true">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul class="easyui-tree" data-options="lines:true">
                    <li>
                        <span>区域选择</span>
                        <ul>
                            <li><span><a href="#">管理员</a></span></li>
                            <li><span><a href="#">操作员</a></span></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div data-options="region:'center'" style="padding:4px;">
                <table class="easyui-datagrid " style="width:100%"></table>
            </div>
        </div>
    </div>

    <!--客户管理-->
    <div id="customer_manage_panel" class="easyui-panel opt_panel" style="width:100%; height:100%; "
         data-options="fit:true, closed:true, border:false, onOpen:onOpenCustomerManagePanel">
        <!--<button onclick="save1()">save</button>-->
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul id="classification_tree" class="easyui-tree" data-options="lines:true,onSelect:loadCustomerGrid,
                        onContextMenu: function(e,node){
                                            e.preventDefault();
                                            $(this).tree('select',node.target);
                                            $('#mm').menu('show',{
                                                left: e.pageX,
                                                top: e.pageY
                                            });
                                        }">
                </ul>
                <div id="mm" class="easyui-menu" style="width:120px;" data-options="">
                    <div onclick="edit_classification_tree_node()" data-options="iconCls:'icon-add'">编辑此编码</div>
                    <div onclick="append_classification_tree_node()" data-options="iconCls:'icon-add'">添加子编码</div>
                    <div onclick="delete_classification_tree_node()" data-options="iconCls:'icon-remove'">删除此编码</div>
                </div>

                <div id="dlg_for_classification" class="easyui-dialog" style="width:400px"
                     data-options="closed:true,modal:true,border:'thin',buttons:'#dlg_buttons_for_classification'">
                    <form id="fm_for_classification" method="post" novalidate style="margin:0;padding:20px 50px">
                        <div style="margin-bottom:10px">
                            <input name="text" id="classification_name_textbox" class="easyui-textbox" required="true"
                                   label="编码名称：" labelAlign="right" style="width:100%">
                        </div>
                    </form>
                </div>
                <div id="dlg_buttons_for_classification">
                    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok"
                       onclick="saveClassification()" style="width:90px">Save</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
                       onclick="javascript:$('#dlg_for_classification').dialog('close')" style="width:90px">Cancel</a>
                </div>
            </div>
            <div data-options="region:'center'" style="padding:0px;">
                <table id="grid_for_customer" style="width:100%"></table>

                <div id="customer_grid_toolbar" style="padding:2px 5px;">
                    <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="newCustomer()">添加</a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true"
                       onclick="editCustomer()">编辑</a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="destroyCustomer()">删除</a>
                    <a href="#" class="easyui-linkbutton" iconCls="icon-cut" plain="true" onclick="exportExcel()">导出到excel</a>
                    <span style="margin-left:100px">检索：<input type="text" id="customer_search_text" style="width:200px"
                                                              onkeyup="onSearch(this, CUSTOMER_GRID)"></span>
                </div>

                <div id="dlg_for_customer" class="easyui-dialog" style="width:500px"
                     data-options="closed:true,modal:true,border:'thin',buttons:'#dlg_buttons_for_customer'">
                    <form id="fm_for_customer" method="post" novalidate style="margin:0;padding:20px 50px">
                        <div style="margin-bottom:10px">

                            <input name="name" id="customer_name" class="easyui-textbox" required="true"
                                   label="客户名称：" labelAlign="right" style="width:100%">
                            <input name="_id" id="customer_id" type="hidden"/>
                        </div>
                        <div style="margin-bottom:10px">

                            <input name="index_code" id="customer_index_code"
                                   class="easyui-textbox"
                                   label="客户简码：" labelAlign="right" style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">

                            <input name="classification" id="customer_classification"
                                   class="easyui-combotree"
                                   data-options="data:[], editable:false, required:true, lines:true, onShowPanel:showClassificationCombotree, onBeforeSelect:beforeSelectClassificationCombotree"
                                   label="编码分类：" labelAlign="right" style="width:100%">
                        </div>

                        <div style="margin-bottom:10px">

                            <input id="customer_principal" class="easyui-textbox" name="principal"
                                   labelAlign="right"
                                   required="true" label="联&nbsp;&nbsp;系&nbsp;&nbsp;人：" style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">

                            <input id="customer_phone" class="easyui-textbox" name="phone"
                                   labelAlign="right"
                                   required="true" label="联系电话：" style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">

                            <input id="customer_address" class="easyui-textbox" name="address"
                                   labelAlign="right"
                                   required="true" label="联系地址：" style="width:100%">
                        </div>
                    </form>
                </div>
                <div id="dlg_buttons_for_customer">
                    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveCustomer()"
                       style="width:90px">Save</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
                       onclick="javascript:$('#dlg_for_customer').dialog('close')" style="width:90px">Cancel</a>
                </div>
            </div>
        </div>

    </div>

    <!--产品管理-->
    <div id="product_manage_panel" class="easyui-panel opt_panel" 　
         style="width:800px; height:100%; padding:0px 0px; text-align:center; "
         data-options="fit:true, closed:true, border:false, onOpen:onOpenProductManagePanel">

        <div class="easyui-layout" data-options="fit:true, border:false">
            <div data-options="region:'west'" style="width:300px; padding:4px;">

                <div style="color:red; margin-top:10px; width:100%;">
                    说明：未选择客户，则为管理通用产品信息。
                </div>
                <input id="customer_choose_for_product_manage" class="easyui-textbox"
                       data-options="buttonText:'选择客户',prompt:'选择客户'" style="width:100%;height:32px;">


                <div id="selected_customer_info" style="width:100%; height:300px;"></div>

            </div>
            <div data-options="region:'center'" style="padding:0px;">
                <table id="product_grid" style="width:100%"></table>

                <div id="dlg_for_product" class="easyui-dialog" style="width:500px"
                     data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons_for_product'">
                    <form id="fm_for_product" method="post" novalidate style="margin:0;padding:20px 50px">
                        <div style="margin-bottom:10px">
                            <input name="name" id="product_name" class="easyui-textbox" required="true"
                                   label="品名:" labelAlign="right" style="width:100%">
                            <input name="_id" id="product_id" type="hidden"/>
                        </div>
                        <div style="margin-bottom:10px">
                            <input name="model" id="product_model" class="easyui-textbox" required="true"
                                   label="型号:" labelAlign="right"
                                   style="width:100%">
                        </div>

                        <div style="margin-bottom:10px">
                            <input name="units" id="product_units" class="easyui-textbox" required="true"
                                   label="单位:" labelAlign="right"
                                   style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">
                            <input name="price" id="product_price" class="easyui-textbox"
                                   label="单价:" labelAlign="right"
                                   style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">
                            <input id="product_memo" class="easyui-textbox" name="memo" labelAlign="right"
                                   label="描述:" style="width:100%">
                        </div>
                    </form>
                </div>
                <div id="dlg-buttons_for_product">
                    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveProduct()"
                       style="width:90px">确定</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
                       onclick="$('#dlg_for_product').dialog('close')" style="width:90px">取消</a>
                </div>

            </div>
        </div>
    </div>

    <!--司机管理-->
    <div id="driver_manage_panel" class="easyui-panel opt_panel"
         data-options="fit:true, closed:true, border:false, onOpen:onOpenDriverManagePanel">
        <div class="easyui-layout" data-options="fit:true, border:false">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul id="car_type_tree" class="easyui-tree" data-options="lines:true,onSelect:loadCarTypes">
                </ul>
            </div>
            <div data-options="region:'center'" style="padding:0px;">
                <table id="driver_grid"></table>
                <div id="dlg_for_driver" class="easyui-dialog" style="width:500px"
                     data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons_for_driver'">
                    <form id="fm_for_driver" method="post" novalidate style="margin:0;padding:20px 50px">
                        <div style="margin-bottom:10px">
                            <input name="name" id="driver_name" class="easyui-textbox" required="true"
                                   label="司机名称:" labelAlign="right" style="width:100%">
                            <input name="_id" id="driver_id" type="hidden"/>
                        </div>

                        <div style="margin-bottom:10px">
                            <select name="car_type" id="driver_car_type" class="easyui-combobox" required="true"
                                    editable="false"
                                    label="车型载重:" labelAlign="right"
                                    style="width:100%">
                                <option value="9.6米平板车-18吨">9.6米平板车-18吨</option>
                                <option value="9.6米高栏车-18吨">9.6米高栏车-18吨</option>
                                <option value="8.5米平板车-10吨">8.5米平板车-10吨</option>
                                <option value="8.5米高栏车-10吨">8.5米高栏车-10吨</option>
                                <option value="6.8米平板车-5吨">6.8米平板车-5吨</option>
                                <option value="6.8米高栏车-5吨">6.8米高栏车-5吨</option>
                            </select>
                        </div>

                        <div style="margin-bottom:10px">
                            <input name="car_No" id="driver_car_No" class="easyui-textbox" required="true"
                                   label="车牌号码:" labelAlign="right"
                                   style="width:100%">
                        </div>

                        <div style="margin-bottom:10px">
                            <input name="id_No" id="driver_id_No" class="easyui-textbox" required="true"
                                   label="身份证号:" labelAlign="right"
                                   style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">
                            <input name="driving_license_No" id="driver_driving_license_No" class="easyui-textbox"
                                   required="true"
                                   label="行驶证号:" labelAlign="right"
                                   style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">
                            <input id="driver_phone" class="easyui-textbox" name="phone" labelAlign="right"
                                   label="联系电话:" style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">
                            <input id="driver_address" class="easyui-textbox" name="address" labelAlign="right"
                                   label="联系地址:" style="width:100%">
                        </div>
                    </form>
                </div>
                <div id="dlg-buttons_for_driver">
                    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveDriver()"
                       style="width:90px">确定</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
                       onclick="javascript:$('#dlg_for_driver').dialog('close')" style="width:90px">取消</a>
                </div>
            </div>
        </div>
    </div>

    <!--登录用户管理-->
    <div id="user_manage_panel" class="easyui-panel opt_panel"
         data-options="fit:true, border:false, closed:true, onOpen:onOpenUserManagePanel">
        <div class="easyui-layout" data-options="fit:true, border:false">
            <div data-options="region:'west'" style="width:180px; padding:4px;">
                <ul id="role_tree" class="easyui-tree" data-options="lines:true,onSelect:loadSysUsers">
                </ul>
            </div>
            <div data-options="region:'center'" style="padding:0px;">
                <table id="sys_user_datagrid"></table>
                <div id="dlg" class="easyui-dialog" style="width:400px"
                     data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons'">
                    <form id="fm" method="post" novalidate style="margin:0;padding:20px 50px">
                        <div style="margin-bottom:10px">
                            <input name="name" id="name_textbox" class="easyui-textbox" required="true"
                                   label="用&nbsp;&nbsp;户&nbsp;&nbsp;名:" labelAlign="right" style="width:100%">
                            <input name="_id" id="user_id" type="hidden"/>
                        </div>
                        <div style="margin-bottom:10px">
                            <input name="role" id="role_combobox" class="easyui-combobox" required="true"
                                   label="角&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;色:" labelAlign="right"
                                   style="width:100%">
                        </div>
                        <div style="margin-bottom:10px">

                            <input id="disabled_checkbox" class="easyui-checkbox" name="disabled" labelAlign="right"
                                   label="禁&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用:">

                        </div>
                    </form>
                </div>
                <div id="dlg-buttons">
                    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveUser()"
                       style="width:90px">确定</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
                       onclick="javascript:$('#dlg').dialog('close')" style="width:90px">取消</a>
                </div>
            </div>
        </div>
    </div>


    <!--系统设置-->
    <div id="sys_config_panel" class="easyui-panel opt_panel"
         data-options="fit:true, closed:true, border:true, onOpen:onOpenSysConfigPanel">
        <div class="easyui-panel"
             data-options="title:'系统设置', width:600, style:{marginLeft:'auto', marginRight:'auto', marginTop:20}">
            <form id="fm_for_system" method="post" novalidate style="margin:0;padding:20px 50px">
                <div style="margin-top:20px">
                    <input id="company_name" class="easyui-textbox" required="true"
                           label="公司名称：" labelAlign="right" style="width:100%">
                </div>
                <div style="margin-top:20px">
                    <input id="company_phone"
                           class="easyui-textbox"
                           label="公司电话：" labelAlign="right" style="width:100%">
                </div>
                <div style="margin-top:20px">
                    <input id="company_address"
                           class="easyui-textbox"
                           label="公司地址：" labelAlign="right" style="width:100%">
                </div>
                <div style="margin-top:20px">
                    <input id="company_logo" class="easyui-textbox"
                           labelAlign="right"
                           label="公司logo：" style="width:100%">
                </div>
                <div style="margin-top:40px;">
                    <a onclick="set_company()"
                       class="easyui-linkbutton"
                       style="width:100px">确定</a>
                </div>
            </form>
        </div>

    </div>

    <!--用户设置密码 -->
    <div id="password_set_panel" class="easyui-panel opt_panel"
         data-options="fit:true, closed:true, border:true, onOpen:onOpenDriverManagePanel">
        <div class="easyui-panel"
             data-options="title:'修改用户密码', width:600, style:{marginLeft:'auto', marginRight:'auto', marginTop:20}">
            <form id="fm_for_password_set" method="post" novalidate style="margin:0;padding:20px 50px">
                <div style="margin-top:20px">
                    <input id="old_pass" class="easyui-textbox"
                           label="旧&nbsp;&nbsp;&nbsp;&nbsp;密&nbsp;&nbsp;&nbsp;&nbsp;码：" labelWidth="100"
                           labelAlign="left" style="width:100%">
                </div>
                <div style="margin-top:20px">
                    <input id="new_pass"
                           class="easyui-textbox"
                           label="新&nbsp;&nbsp;&nbsp;&nbsp;密&nbsp;&nbsp;&nbsp;&nbsp;码：" labelWidth="100"
                           labelAlign="left" style="width:100%">
                </div>
                <div style="margin-top:20px">
                    <input id="new_pass_again"
                           class="easyui-textbox"
                           label="重复新密码：" labelAlign="left" labelWidth="100" style="width:100%">
                </div>

                <div style="margin-top:40px;">
                    <a onclick="set_password()"
                       class="easyui-linkbutton"
                       style="width:100px">确定</a>
                </div>
            </form>
        </div>
    </div>


</div>


<div id="dlg_for_customer_choose" title="选择客户" class="easyui-dialog" style="width:900px; height:550px;"
     data-options="onOpen:onOpenCustomerChooseDlg, resizable:true, closed:true, modal:true, border:'thin', buttons:'#dlg_buttons_for_classification01'">
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'west'" style="width:180px; padding:4px;">
            <ul id="classification_tree01" class="easyui-tree" data-options="lines:true,onSelect:loadCustomerGrid01,
                      ">
            </ul>
        </div>
        <div data-options="region:'center'" style="padding:0px;">
            <table id="grid_for_customer01" style="width:100%">
            </table>
        </div>
    </div>

    <script>

        let CUSTOMER_GRID01 = null;

        function loadCustomerGrid01(node) {

            let t = $('#classification_tree01')
            if (node == null) {
                node = t.tree('getSelected')
            }

            let rootNode = t.tree('getRoot')

            let params = {}
            if (node == null || node == rootNode) {

            } else if (t.tree('isLeaf', node.target)) {
                console.log("Select classification node is a leaf.")
                params.classification = node.text;
            } else {
                let arr = [node.text]
                let children = t.tree('getChildren', node.target)
                // children包含所有子节点
                for (let i = 0; i < children.length; i++) {
                    arr.push(children[i].text)
                }
                params.classification = {$in: arr}
            }

            console.log("Classification params is " + JSON.stringify(params))


            if (CUSTOMER_GRID01 == null) {
                CUSTOMER_GRID01 = $('#grid_for_customer01').datagrid({
                    fit: true,
                    singleSelect: true,
                    collapsible: false,
                    data: [],
                    border: false,
                    remoteSort: false,
                    multiSort: true,
                    showFilterBar: false,
                    rownumbers: true,
                    title: '<span style="font-weight: bold">客户列表</span>',
                    width: 720,
                    toolbar: '#customer_grid_toolbar01',
                    columns: [[
                        {title: "客户编码", field: 'classification', width: 80, sortable: true, sortOrder: 'asc'},
                        {title: "客户名称", field: 'name', width: 200, sortable: true, sortOrder: 'asc'},
                        {title: "客户简码", field: 'index_code', width: 80, sortable: true, sortOrder: 'asc'},
                        {title: "联系人", field: "principal", width: 80},
                        {title: "联系电话", field: 'phone', width: 100},
                        {title: "联系地址", field: 'address', width: 220}
                    ]]
                })
                enable_customer_filter = false;
            }

            if (params == null) {
                params = {}
            }
            mongoose.CustomerModel.find(params, function (err, docs) {
                CUSTOMER_GRID01.datagrid('loadData', docs)
                CUSTOMER_GRID01.datagrid('enableFilter', {filterMatchingType: 'any'})
            })
        }

        function onOpenCustomerChooseDlg() {

            console.log("openCustomerChooseDlg")
            // 加载分类树
            loadClassifications(function (data) {
                $('#classification_tree01').tree('loadData', data)
            })

            // 加载客户列表
            loadCustomerGrid01(null)
        }


        let customer_choose_dlg_type = null;

        function chooseCustomer(callback) {
            $('#dlg_for_customer_choose').dialog('close')
            let row = CUSTOMER_GRID01.datagrid('getSelected')
            if (row) {

                if (customer_choose_dlg_type == 'list_products') {
                    $('#customer_choose_for_product_manage').textbox("setValue", row._id).textbox("setText", row.name)
                    $('#customer_choose_for_product_manage').textbox('textbox').keyup()
                    loadProducts()

                } else if (customer_choose_dlg_type == 'new_order') {
                    $('#new_order_customer_name').textbox("setValue", row._id).textbox("setText", row.name)
                    $('#new_order_customer_name').textbox('textbox').keyup()

                    // fill new order
                    $('#new_order_customer_phone').textbox('setValue', row.phone)
                    $('#new_order_customer_principal').textbox('setValue', row.principal)
                    $('#new_order_customer_address').textbox('setValue', row.address)

                    resetOrderProductGrid(true)


                }
            }
        }

    </script>
</div>
<div id="customer_grid_toolbar01" style="padding:2px 5px;">
  <span style="margin-left:0px">检索：<input type="text" id="customer_search_text01" style="width:200px"
                                          onkeyup="onSearch(this, CUSTOMER_GRID01)"></span>
</div>

<div id="dlg_buttons_for_classification01">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok"
       onclick="chooseCustomer()" style="width:90px">确定选择</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
       onclick="javascript:$('#dlg_for_customer_choose').dialog('close')" style="width:90px">取消</a>
</div>


<!-- 产品选择对话框 -->
<div id="dlg_for_product_choose" title="选择产品" class="easyui-dialog" style="width:700px; height:500px;"
     data-options="onBeforeOpen:onOpenProductChooseDlg, resizable:true, closed:true, modal:true, border:'thin', buttons:'#dlg_buttons_for_product_choose01'">
    <table id="grid_for_product01" style="width:100%">
    </table>
</div>
<div id="dlg_buttons_for_product_choose01">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok"
       onclick="chooseProduct()" style="width:90px">确定选择</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel"
       onclick="javascript:$('#dlg_for_product_choose').dialog('close')" style="width:90px">取消</a>
</div>

<div id="win" class="easyui-window" title="" style="background-color: #95B8E7"
     data-options="modal:true, closed:true, height:50, width:200, border:false,  style:{textAlign:'center'}">
    <span style="height:50px;  line-height:50px; margin:0 auto; " id="win_in"></span>
</div>

<script>

    $(function () {
        $('#new_order_sale_date').datebox().datebox('calendar').calendar({
            validator: function (date) {
                var now = new Date();
                var d1 = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                var d2 = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 6);
                return d1 <= date && date <= d2;
            }
        });
    });


    const {ipcRenderer} = require('electron')
    let win = require('electron').remote.getCurrentWindow();

    win.on('close', () => {
        ipcRenderer.sendSync('app-quit')
    });

    function logout() {
        ipcRenderer.sendSync('logout')
    }

    const {BrowserWindow} = require('electron').remote

    function printit() {
        let parent = require('electron').remote.getCurrentWindow()
        let win_print = new BrowserWindow({
            width: 800,
            height: 550,
            modal: true,
            show: false,
            maximizable: false,
            minimizable: false,
            resizable: false,
            parent: parent,
            title: '打印',
            autoHideMenuBar: true
        })
        win_print.on('closed', () => {
            win_print = null
           $('#win').window('close')
            $.messager.confirm('', '是否继续填写出库单?', function(r){
                if (r){
                    //alert('confirmed: '+r);
                    //var opts = $('#new_order_customer_name').textbox('options');
                    //$(opts.icons[0]).onclick()//opts.icons || [];  fixed
                    resetOrder();
                } else {
                    $('#order_list_menu').click()
                }
            });
        })
        win_print.loadURL('file://' + __dirname + '/print_template.html')
        win_print.show()
    }
</script>
</body>
</html>